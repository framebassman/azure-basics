name: CI
on:
  pull_request:
    branches:
      - 'master'
jobs:
  Test:
    runs-on: ubuntu-22.04
    steps:
      - uses: actions/checkout@v3
      - uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '8.0.x'
      - run: dotnet test ProjectTasks.Api.Tests.Unit
  Build:
    runs-on: ubuntu-latest
    outputs:
      BUILD_BUILDNUMBER: ${{ steps.new-version.outputs.BUILD_BUILDNUMBER }}
    permissions:
      id-token: write
      contents: write
      pull-requests: write
    steps:
      - uses: actions/checkout@v4
      -
        uses: actions-ecosystem/action-get-latest-tag@v1.6.0
        id: get-latest-tag
      -
        uses: actions-ecosystem/action-bump-semver@v1
        id: bump-semver
        with:
          current_version: ${{ steps.get-latest-tag.outputs.tag }}
          level: minor
      - name: Set new version
        id: new-version
        run: echo "BUILD_BUILDNUMBER=${{ steps.bump-semver.outputs.new_version }}" >> $GITHUB_OUTPUT
      -
        uses: actions-ecosystem/action-push-tag@v1
        with:
          tag: ${{ steps.bump-semver.outputs.new_version }}
          message: '${{ steps.bump-semver.outputs.new_version }}'
      -
        name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: framebassman
          password: ${{ secrets.DOCKERHUB_TOKEN }}
      -
        name: Build and push web
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./ProjectTasks.Api/Dockerfile
          push: true
          tags: framebassman/project_tasks_api:${{ env.BUILD_BUILDNUMBER }}
        env:
          BUILD_BUILDNUMBER: ${{ steps.new-version.outputs.BUILD_BUILDNUMBER }}
